{{- if and .Values.k6.enabled (eq .Values.k6.enabled true) }}
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: react-demo-k6-loadtest
  namespace: testing
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  script:
    configMap:
      name: react-demo-loadtest-script
      file: script.js
  parallelism: 3
  arguments: -o experimental-opentelemetry --tag testid=react-demo
  runner:
    env:
      - name: K6_OTEL_EXPORTER_TYPE
        value: "grpc"
      - name: K6_OTEL_GRPC_EXPORTER_INSECURE
        value: "true"
      - name: K6_OTEL_GRPC_EXPORTER_ENDPOINT
        value: "opentelemetry-collector.observability.svc.cluster.local:4317"
      - name: K6_OTEL_SERVICE_NAME
        value: "k6-load-test"
      - name: K6_OTEL_METRIC_PREFIX
        value: "k6_"
    envFrom:
      - secretRef:
          name: react-demo-bearer-token
  cleanup: post
{{- end }}
